---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.19.0
  name: nodegroups.autoscaler.vpsie.com
spec:
  group: autoscaler.vpsie.com
  names:
    kind: NodeGroup
    listKind: NodeGroupList
    plural: nodegroups
    shortNames:
    - ng
    - ngs
    singular: nodegroup
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - description: Minimum nodes
      jsonPath: .spec.minNodes
      name: Min
      type: integer
    - description: Maximum nodes
      jsonPath: .spec.maxNodes
      name: Max
      type: integer
    - description: Desired nodes
      jsonPath: .status.desiredNodes
      name: Desired
      type: integer
    - description: Current nodes
      jsonPath: .status.currentNodes
      name: Current
      type: integer
    - description: Ready nodes
      jsonPath: .status.readyNodes
      name: Ready
      type: integer
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: NodeGroup is the Schema for the nodegroups API
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: NodeGroupSpec defines the desired state of NodeGroup
            properties:
              allowMixedInstances:
                default: true
                description: AllowMixedInstances allows the node group to contain
                  nodes with different instance types
                type: boolean
              costOptimization:
                description: CostOptimization defines cost optimization settings for
                  this NodeGroup
                properties:
                  enabled:
                    default: true
                    description: Enabled controls whether cost optimization is active
                      for this NodeGroup
                    type: boolean
                  maxPerformanceImpact:
                    default: 5
                    description: MaxPerformanceImpact is the maximum acceptable performance
                      reduction percentage
                    format: int32
                    maximum: 100
                    minimum: 0
                    type: integer
                  minMonthlySavings:
                    default: 10
                    description: MinMonthlySavings is the minimum monthly savings
                      required to apply optimization
                    type: number
                  optimizationInterval:
                    default: 24h
                    description: OptimizationInterval is the minimum time between
                      optimization actions
                    type: string
                  requireApproval:
                    default: false
                    description: RequireApproval controls whether optimizations require
                      manual approval
                    type: boolean
                  strategy:
                    default: auto
                    description: |-
                      Strategy defines the optimization strategy
                      Values: "auto", "manual", "aggressive", "conservative"
                    type: string
                type: object
              datacenterID:
                description: DatacenterID is the VPSie datacenter ID where nodes will
                  be created
                type: string
              kubernetesVersion:
                description: |-
                  KubernetesVersion is the Kubernetes version to install on new nodes (e.g., "v1.28.0", "v1.29.1")
                  Must be within Â±1 minor version of the control plane
                pattern: ^v(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(?:-((?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\.(?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\+([0-9a-zA-Z-]+(?:\.[0-9a-zA-Z-]+)*))?$
                type: string
              labels:
                additionalProperties:
                  type: string
                description: Labels are the Kubernetes labels to apply to nodes in
                  this group
                type: object
              maxNodes:
                description: MaxNodes is the maximum number of nodes in this group
                format: int32
                minimum: 1
                type: integer
              minNodes:
                description: MinNodes is the minimum number of nodes in this group
                format: int32
                minimum: 0
                type: integer
              multiRegion:
                description: MultiRegion enables multi-region/datacenter distribution
                  for high availability
                properties:
                  datacenterIDs:
                    description: |-
                      DatacenterIDs is a list of datacenter IDs to distribute nodes across
                      If empty, uses the primary DatacenterID from NodeGroupSpec
                    items:
                      type: string
                    type: array
                  distributionStrategy:
                    default: balanced
                    description: |-
                      DistributionStrategy defines how to distribute nodes across regions
                      Values: "balanced", "weighted", "primary-backup"
                    type: string
                  enabled:
                    default: false
                    description: Enabled controls whether multi-region distribution
                      is active
                    type: boolean
                  minNodesPerRegion:
                    default: 1
                    description: MinNodesPerRegion is the minimum number of nodes
                      per region
                    format: int32
                    minimum: 0
                    type: integer
                  primaryDatacenter:
                    description: PrimaryDatacenter is the primary datacenter for "primary-backup"
                      strategy
                    type: string
                  weightedDistribution:
                    additionalProperties:
                      format: int32
                      type: integer
                    description: |-
                      WeightedDistribution defines custom weights for each datacenter
                      Only used when DistributionStrategy is "weighted"
                      Key is datacenter ID, value is weight (higher = more nodes)
                    type: object
                type: object
              notes:
                description: Notes are additional notes to attach to VPSie instances
                type: string
              offeringIDs:
                description: |-
                  OfferingIDs is a list of allowed VPSie offering/boxsize IDs for this node group
                  The autoscaler will choose the most cost-effective offering that satisfies resource requirements
                items:
                  type: string
                minItems: 1
                type: array
              osImageID:
                description: OSImageID is the VPSie OS image ID to use for new nodes
                type: string
              preferredInstanceType:
                description: PreferredInstanceType is the preferred offering ID to
                  use when multiple options are available
                type: string
              scaleDownPolicy:
                description: ScaleDownPolicy defines when and how to scale down the
                  node group
                properties:
                  cooldownSeconds:
                    default: 600
                    description: |-
                      CooldownSeconds is the time to wait after a scale-up before allowing scale-down
                      This prevents scaling down immediately after scaling up
                    format: int32
                    minimum: 0
                    type: integer
                  cpuThreshold:
                    default: 50
                    description: |-
                      CPUThreshold is the CPU utilization percentage below which scale-down is considered
                      Scale down when node CPU usage is below this threshold for the stabilization window
                    format: int32
                    maximum: 100
                    minimum: 0
                    type: integer
                  enabled:
                    default: true
                    description: Enabled controls whether automatic scale-down is
                      enabled
                    type: boolean
                  memoryThreshold:
                    default: 50
                    description: |-
                      MemoryThreshold is the memory utilization percentage below which scale-down is considered
                      Scale down when node memory usage is below this threshold for the stabilization window
                    format: int32
                    maximum: 100
                    minimum: 0
                    type: integer
                  stabilizationWindowSeconds:
                    default: 600
                    description: |-
                      StabilizationWindowSeconds is the time to wait before scaling down after conditions are met
                      This prevents premature scale-down and gives time for resource usage patterns to stabilize
                    format: int32
                    minimum: 0
                    type: integer
                type: object
              scaleUpPolicy:
                description: ScaleUpPolicy defines when and how to scale up the node
                  group
                properties:
                  cpuThreshold:
                    default: 80
                    description: |-
                      CPUThreshold is the CPU utilization percentage that triggers scale-up
                      Scale up when average CPU usage across nodes exceeds this threshold
                    format: int32
                    maximum: 100
                    minimum: 0
                    type: integer
                  enabled:
                    default: true
                    description: Enabled controls whether automatic scale-up is enabled
                    type: boolean
                  memoryThreshold:
                    default: 80
                    description: |-
                      MemoryThreshold is the memory utilization percentage that triggers scale-up
                      Scale up when average memory usage across nodes exceeds this threshold
                    format: int32
                    maximum: 100
                    minimum: 0
                    type: integer
                  stabilizationWindowSeconds:
                    default: 60
                    description: |-
                      StabilizationWindowSeconds is the time to wait before scaling up after conditions are met
                      This prevents flapping when resource usage fluctuates
                    format: int32
                    minimum: 0
                    type: integer
                type: object
              spotConfig:
                description: SpotConfig defines spot instance configuration for cost
                  savings
                properties:
                  allowedInterruptionRate:
                    default: 20
                    description: |-
                      AllowedInterruptionRate is the maximum interruption rate per hour
                      Helps avoid offerings with high interruption rates
                    format: int32
                    maximum: 100
                    minimum: 0
                    type: integer
                  enabled:
                    default: false
                    description: Enabled controls whether spot instances are used
                    type: boolean
                  fallbackToOnDemand:
                    default: true
                    description: FallbackToOnDemand controls whether to fall back
                      to on-demand if spot unavailable
                    type: boolean
                  interruptionGracePeriod:
                    default: 120s
                    description: InterruptionGracePeriod is the time before spot termination
                      to drain workloads
                    type: string
                  maxSpotPercentage:
                    default: 80
                    description: |-
                      MaxSpotPercentage is the maximum percentage of nodes that can be spot instances
                      This ensures some on-demand capacity for stability
                    format: int32
                    maximum: 100
                    minimum: 0
                    type: integer
                type: object
              sshKeyIDs:
                description: SSHKeyIDs is a list of VPSie SSH key IDs to install on
                  new nodes
                items:
                  type: string
                type: array
              tags:
                description: Tags are key-value pairs to tag VPSie instances for organization
                  and billing
                items:
                  type: string
                type: array
              taints:
                description: Taints are the Kubernetes taints to apply to nodes in
                  this group
                items:
                  description: |-
                    The node this Taint is attached to has the "effect" on
                    any pod that does not tolerate the Taint.
                  properties:
                    effect:
                      description: |-
                        Required. The effect of the taint on pods
                        that do not tolerate the taint.
                        Valid effects are NoSchedule, PreferNoSchedule and NoExecute.
                      type: string
                    key:
                      description: Required. The taint key to be applied to a node.
                      type: string
                    timeAdded:
                      description: |-
                        TimeAdded represents the time at which the taint was added.
                        It is only written for NoExecute taints.
                      format: date-time
                      type: string
                    value:
                      description: The taint value corresponding to the taint key.
                      type: string
                  required:
                  - effect
                  - key
                  type: object
                type: array
              userData:
                description: |-
                  UserData is cloud-init user data to configure new nodes
                  This should include the script to join the node to the Kubernetes cluster
                type: string
            required:
            - datacenterID
            - kubernetesVersion
            - maxNodes
            - minNodes
            - offeringIDs
            - osImageID
            type: object
          status:
            description: NodeGroupStatus defines the observed state of NodeGroup
            properties:
              conditions:
                description: Conditions represent the latest available observations
                  of the NodeGroup's state
                items:
                  description: NodeGroupCondition describes the state of a NodeGroup
                    at a certain point
                  properties:
                    lastTransitionTime:
                      description: LastTransitionTime is the last time the condition
                        transitioned from one status to another
                      format: date-time
                      type: string
                    lastUpdateTime:
                      description: LastUpdateTime is the last time this condition
                        was updated
                      format: date-time
                      type: string
                    message:
                      description: Message is a human-readable message indicating
                        details about last transition
                      type: string
                    reason:
                      description: Reason is a one-word CamelCase reason for the condition's
                        last transition
                      type: string
                    status:
                      description: Status of the condition (True, False, Unknown)
                      type: string
                    type:
                      description: Type of condition
                      type: string
                  required:
                  - status
                  - type
                  type: object
                type: array
              currentNodes:
                description: CurrentNodes is the actual number of nodes currently
                  in the group
                format: int32
                type: integer
              desiredNodes:
                description: DesiredNodes is the number of nodes the autoscaler wants
                  to maintain
                format: int32
                type: integer
              lastScaleDownTime:
                description: LastScaleDownTime is the timestamp of the last scale-down
                  operation
                format: date-time
                type: string
              lastScaleTime:
                description: LastScaleTime is the timestamp of the last scaling operation
                format: date-time
                type: string
              lastScaleUpTime:
                description: LastScaleUpTime is the timestamp of the last scale-up
                  operation
                format: date-time
                type: string
              nodes:
                description: Nodes is a list of nodes in this group with their details
                items:
                  description: NodeInfo contains information about a node in the NodeGroup
                  properties:
                    createdAt:
                      description: CreatedAt is when the node was created
                      format: date-time
                      type: string
                    instanceType:
                      description: InstanceType is the VPSie offering/boxsize ID
                      type: string
                    ipAddress:
                      description: IPAddress is the primary IP address of the node
                      type: string
                    nodeName:
                      description: NodeName is the Kubernetes node name
                      type: string
                    readyAt:
                      description: ReadyAt is when the node became ready
                      format: date-time
                      type: string
                    status:
                      description: Status is the current status of the node (Provisioning,
                        Ready, Terminating, etc.)
                      type: string
                    vpsID:
                      description: VPSID is the VPSie instance ID
                      type: integer
                  required:
                  - instanceType
                  - nodeName
                  - status
                  - vpsID
                  type: object
                type: array
              observedGeneration:
                description: ObservedGeneration is the generation observed by the
                  controller
                format: int64
                type: integer
              readyNodes:
                description: ReadyNodes is the number of nodes that are ready to accept
                  workloads
                format: int32
                type: integer
            required:
            - currentNodes
            - desiredNodes
            - readyNodes
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
