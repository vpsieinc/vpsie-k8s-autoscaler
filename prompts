# VPSie Kubernetes Node Autoscaler - Phase 4: Production Readiness Prompts

## Overview
These prompts guide the implementation of Phase 4 (Production Readiness) for the VPSie Kubernetes Node Autoscaler. Each prompt addresses critical production requirements identified through comprehensive project analysis. Execute these prompts in priority order to achieve production readiness.

---

## Priority 1: Scale-Down Logic Implementation (BLOCKER)

**Context:** The pkg/scaler/ directory is empty. Scale-down logic is critical for production as it prevents resource waste and reduces costs.

**Requirements:**
1. Implement pkg/scaler/scaler.go with ScaleDownManager:
   - Identify underutilized nodes (CPU < 50%, Memory < 50%)
   - Respect scale-down cooldown period (default 10 minutes)
   - Implement node draining with pod eviction
   - Verify no PDBs (PodDisruptionBudgets) are violated
   - Check for non-reschedulable pods (local storage, node selectors)
   - Implement graceful termination with timeout

2. Add pkg/scaler/metrics.go for utilization tracking:
   - Collect node metrics from metrics-server
   - Calculate rolling averages over 5-minute windows
   - Track pod resource requests vs actual usage
   - Identify cost-saving opportunities

3. Implement pkg/scaler/drain.go for safe node removal:
   - Cordon node to prevent new pod scheduling
   - Evict pods respecting grace periods
   - Wait for pod termination
   - Handle DaemonSets and static pods
   - Verify workload migration success

4. Create pkg/scaler/policies.go for configurable policies:
   - Time-based scaling (business hours vs off-hours)
   - Aggressive vs conservative modes
   - Protected node annotations
   - Cost optimization strategies

5. Add comprehensive tests:
   - Unit tests with 90% coverage
   - Integration tests for scale-down scenarios
   - Test PDB respect, failed evictions, timeout handling

**Expected Outcome:** Fully functional scale-down with safe node removal, cost optimization, and configurable policies.

---

## Priority 2: Deployment Manifests (BLOCKER)

**Context:** deploy/ directory lacks production deployment manifests. Helm chart is incomplete.

**Requirements:**
1. Complete Helm chart in deploy/helm/vpsie-autoscaler/:
   - Chart.yaml with proper versioning
   - values.yaml with all configurable options
   - templates/deployment.yaml with resource limits
   - templates/rbac.yaml with minimal required permissions
   - templates/configmap.yaml for configuration
   - templates/secret.yaml for VPSie credentials
   - templates/service.yaml for metrics exposure
   - templates/servicemonitor.yaml for Prometheus
   - templates/poddisruptionbudget.yaml for HA
   - templates/networkpolicy.yaml for security

2. Create deploy/kubernetes/ for kubectl users:
   - namespace.yaml
   - rbac.yaml (ServiceAccount, ClusterRole, ClusterRoleBinding)
   - deployment.yaml with leader election
   - configmap.yaml with default configuration
   - secret.yaml template
   - service.yaml for metrics
   - poddisruptionbudget.yaml

3. Add deploy/examples/ with production configs:
   - small-cluster.yaml (1-10 nodes)
   - medium-cluster.yaml (10-50 nodes)
   - large-cluster.yaml (50+ nodes)
   - multi-region.yaml
   - spot-instances.yaml

4. Create deploy/kustomize/ for GitOps:
   - base/ with core resources
   - overlays/dev/
   - overlays/staging/
   - overlays/production/

5. Add validation and testing:
   - Helm chart linting
   - Dry-run installation tests
   - RBAC permission validation
   - Resource limit testing

**Expected Outcome:** Production-ready deployment manifests supporting multiple installation methods.

---

## Priority 3: Node Bootstrapping System (BLOCKER)

**Context:** New VPSie VMs need to join the Kubernetes cluster automatically.

**Requirements:**
1. Create pkg/bootstrap/bootstrapper.go:
   - Generate kubeadm join tokens
   - Manage token rotation and expiration
   - Store bootstrap configuration in ConfigMaps
   - Track join status and retry failures

2. Implement pkg/bootstrap/cloud_init.go:
   - Generate cloud-init templates
   - Install Docker/containerd
   - Install kubelet, kubeadm, kubectl
   - Configure kernel parameters and sysctl
   - Set up CNI networking
   - Join cluster using kubeadm

3. Add pkg/bootstrap/templates/ with cloud-init:
   - ubuntu-22.04.yaml
   - ubuntu-20.04.yaml
   - centos-8.yaml
   - debian-11.yaml
   - Custom startup scripts

4. Create pkg/bootstrap/validation.go:
   - Verify node joined successfully
   - Check kubelet health
   - Validate CNI configuration
   - Test pod scheduling
   - Monitor for bootstrap failures

5. Implement recovery mechanisms:
   - Retry failed joins with backoff
   - Clean up failed nodes
   - Alert on repeated failures
   - Automatic token refresh

**Expected Outcome:** Automated node bootstrapping with 99.9% success rate.

---

## Priority 4: Configuration Management (BLOCKER)

**Context:** Found 9 TODO comments with hardcoded configuration values throughout the codebase.

**Requirements:**
1. Create internal/config/config.go with Viper:
   - Load from file, env vars, and flags
   - Validate configuration on startup
   - Support hot-reload for non-critical settings
   - Type-safe configuration structs

2. Define configuration structure:
   ```go
   type Config struct {
       Controller ControllerConfig
       VPSie      VPSieConfig
       Scaling    ScalingConfig
       Bootstrap  BootstrapConfig
       Metrics    MetricsConfig
       Logging    LoggingConfig
   }
   ```

3. Fix all hardcoded values:
   - Controller reconciliation interval (currently 30s)
   - VPSie API rate limits (currently 100/min)
   - Scale-up/down thresholds
   - Timeout values
   - Port numbers
   - Resource limits

4. Add configuration validation:
   - Required fields check
   - Range validation for numeric values
   - Format validation for URLs/IPs
   - Mutual exclusivity rules
   - Warning for deprecated options

5. Create config/config.yaml template:
   - Fully documented with examples
   - Environment variable mappings
   - Default values explained
   - Production recommendations

**Expected Outcome:** Flexible configuration system with no hardcoded values.

---

## Priority 5: Cost Optimization Features

**Context:** VPSie offers multiple instance types. Intelligent selection can reduce costs by 40%.

**Requirements:**
1. Implement pkg/vpsie/cost/calculator.go:
   - Fetch current VPSie pricing
   - Calculate hourly/monthly costs
   - Compare instance types
   - Predict cost impact of scaling

2. Create pkg/vpsie/cost/optimizer.go:
   - Analyze workload requirements
   - Recommend optimal instance types
   - Support spot/preemptible instances
   - Implement bin packing algorithm
   - Right-size overprovisioned nodes

3. Add pkg/rebalancer/rebalancer.go:
   - Periodic cluster rebalancing
   - Migrate workloads to cheaper instances
   - Consolidate underutilized nodes
   - Respect availability requirements
   - Generate rebalancing reports

4. Implement cost tracking:
   - Track spending per NodeGroup
   - Monitor cost trends
   - Alert on budget exceeded
   - Generate cost reports
   - Export metrics to Prometheus

5. Add optimization policies:
   - Aggressive cost saving mode
   - Balanced performance/cost
   - Performance priority mode
   - Time-based policies

**Expected Outcome:** 30-40% cost reduction through intelligent instance selection.

---

## Priority 6: Production Observability

**Context:** Current metrics/logging insufficient for production debugging.

**Requirements:**
1. Enhance pkg/metrics/ with detailed metrics:
   - Scaling decision reasons
   - Node lifecycle durations
   - API call latencies (P50, P95, P99)
   - Error rates by category
   - Cost metrics
   - Cluster efficiency score

2. Implement distributed tracing:
   - OpenTelemetry integration
   - Trace scaling decisions
   - Track API call chains
   - Correlate with logs
   - Export to Jaeger/Zipkin

3. Add structured events:
   - Scaling decisions with reasons
   - Configuration changes
   - Error conditions
   - Cost optimizations
   - Security events

4. Create dashboards:
   - Grafana dashboard JSON
   - Scaling activity overview
   - Cost tracking dashboard
   - Error analysis dashboard
   - Performance metrics

5. Implement alerting rules:
   - Scaling failures
   - High error rates
   - Budget exceeded
   - Performance degradation
   - Security violations

**Expected Outcome:** Complete observability for production operations.

---

## Priority 7: E2E Testing Suite

**Context:** Need end-to-end tests for production validation.

**Requirements:**
1. Create test/e2e/ framework:
   - Cluster provisioning helpers
   - VPSie API mocking
   - Workload generators
   - Metric collectors
   - Report generation

2. Implement core scenarios:
   - Fresh cluster scaling
   - Upgrade testing
   - Failure recovery
   - Multi-region scaling
   - Cost optimization validation

3. Add chaos testing:
   - Network partitions
   - API failures
   - Node failures
   - Controller crashes
   - Resource exhaustion

4. Performance validation:
   - 1000 node scaling
   - Rapid scale up/down
   - Sustained load testing
   - Memory leak detection
   - API rate limit testing

5. Security testing:
   - RBAC validation
   - Secret management
   - Network policy enforcement
   - Admission webhook testing
   - Audit logging validation

**Expected Outcome:** Comprehensive E2E test suite with 95% scenario coverage.

---

## Priority 8: Documentation Completion

**Context:** Missing critical production documentation.

**Requirements:**
1. Create docs/production/:
   - installation.md - Step-by-step guide
   - configuration.md - All options explained
   - troubleshooting.md - Common issues
   - monitoring.md - Metrics and dashboards
   - security.md - Security best practices
   - disaster-recovery.md - Backup/restore
   - migration.md - Version upgrades

2. Add docs/api/:
   - nodegroup-api.md - CRD reference
   - vpsienode-api.md - CRD reference
   - metrics-api.md - Metrics reference
   - events.md - Event reference

3. Create runbooks:
   - Scaling not working
   - High error rates
   - Cost overruns
   - Performance issues
   - Security incidents

4. Add architecture docs:
   - System design
   - Component interactions
   - Scaling algorithms
   - Cost optimization logic
   - Security model

5. Generate API documentation:
   - OpenAPI spec for CRDs
   - Go doc for packages
   - Helm chart values documentation
   - Configuration reference

**Expected Outcome:** Complete documentation for operators and developers.

---

## Priority 9: Security Hardening

**Context:** Production requires security hardening and compliance.

**Requirements:**
1. Implement admission webhooks:
   - Validate NodeGroup configurations
   - Enforce resource limits
   - Check RBAC permissions
   - Prevent dangerous configurations
   - Audit configuration changes

2. Add secret management:
   - Support external secret stores
   - Implement secret rotation
   - Encrypt secrets at rest
   - Audit secret access
   - Support HashiCorp Vault

3. Network security:
   - Implement NetworkPolicies
   - TLS for all communications
   - mTLS for controller components
   - API authentication/authorization
   - Rate limiting

4. Compliance features:
   - Audit logging
   - Change tracking
   - Compliance reports
   - Data retention policies
   - GDPR compliance

5. Security scanning:
   - Container image scanning
   - Dependency vulnerability scanning
   - SAST/DAST integration
   - Security benchmarks
   - CIS compliance checks

**Expected Outcome:** Production-grade security meeting enterprise requirements.

---

## Priority 10: Release Preparation

**Context:** Prepare for v1.0.0 production release.

**Requirements:**
1. Release automation:
   - Semantic versioning
   - Automated changelog generation
   - GitHub release creation
   - Docker image publishing
   - Helm chart publishing

2. Release testing:
   - Upgrade testing
   - Rollback testing
   - Compatibility matrix
   - Performance benchmarks
   - Security audit

3. Release documentation:
   - Release notes template
   - Migration guides
   - Breaking changes
   - Known issues
   - Deprecation notices

4. Support infrastructure:
   - Issue templates
   - PR templates
   - Contributing guidelines
   - Code of conduct
   - Support channels

5. Marketing materials:
   - README badges
   - Architecture diagrams
   - Performance benchmarks
   - Cost savings examples
   - Case studies

**Expected Outcome:** Professional v1.0.0 release ready for production adoption.

---

## Execution Order

1. **Week 1-2:** Priorities 1-4 (Critical blockers)
   - Scale-down logic
   - Deployment manifests
   - Node bootstrapping
   - Configuration management

2. **Week 3:** Priorities 5-6 (Optimization & Observability)
   - Cost optimization
   - Production observability

3. **Week 4:** Priorities 7-8 (Testing & Documentation)
   - E2E testing
   - Documentation

4. **Week 5:** Priorities 9-10 (Security & Release)
   - Security hardening
   - Release preparation

## Success Criteria

- ✅ All 10 priority areas implemented
- ✅ 90% test coverage achieved
- ✅ Zero critical security vulnerabilities
- ✅ Documentation complete
- ✅ E2E tests passing
- ✅ Performance benchmarks met
- ✅ Cost optimization validated
- ✅ Production deployment successful