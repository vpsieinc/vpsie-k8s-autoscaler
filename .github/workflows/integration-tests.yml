name: Integration Tests

on:
  push:
    branches:
      - main
      - develop
      - 'release/**'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - 'Makefile'
      - '.github/workflows/integration-tests.yml'
      - 'test/**'
      - 'pkg/**'
      - 'cmd/**'

env:
  GO_VERSION: '1.21'
  KUBERNETES_VERSION: 'v1.28.0'
  KIND_VERSION: 'v0.20.0'

jobs:
  setup:
    name: Setup Test Environment
    runs-on: ubuntu-latest
    outputs:
      cluster-name: ${{ steps.cluster.outputs.name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Generate CRDs
        run: |
          go install sigs.k8s.io/controller-tools/cmd/controller-gen@latest
          make generate

      - name: Upload CRDs
        uses: actions/upload-artifact@v4
        with:
          name: crds
          path: deploy/crds/
          retention-days: 1

  integration-basic:
    name: Basic Integration Tests
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download CRDs
        uses: actions/download-artifact@v4
        with:
          name: crds
          path: deploy/crds/

      - name: Create kind cluster
        uses: helm/kind-action@v1.8.0
        with:
          version: ${{ env.KIND_VERSION }}
          cluster_name: integration-basic
          node_image: kindest/node:${{ env.KUBERNETES_VERSION }}

      - name: Install CRDs
        run: kubectl apply -f deploy/crds/

      - name: Build controller
        run: make build

      - name: Run basic integration tests
        run: make test-integration-basic
        env:
          KUBECONFIG: ${{ env.KUBECONFIG }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: basic-test-results
          path: |
            coverage-integration.out
            /tmp/controller-*.log
          retention-days: 7

  integration-runtime:
    name: Runtime Integration Tests
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download CRDs
        uses: actions/download-artifact@v4
        with:
          name: crds
          path: deploy/crds/

      - name: Create kind cluster
        uses: helm/kind-action@v1.8.0
        with:
          version: ${{ env.KIND_VERSION }}
          cluster_name: integration-runtime
          node_image: kindest/node:${{ env.KUBERNETES_VERSION }}

      - name: Install CRDs
        run: kubectl apply -f deploy/crds/

      - name: Build controller
        run: make build

      - name: Run runtime integration tests
        run: make test-integration-runtime
        env:
          KUBECONFIG: ${{ env.KUBECONFIG }}

      - name: Upload metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: runtime-metrics
          path: /tmp/metrics-*.json
          retention-days: 7

  integration-shutdown:
    name: Shutdown Integration Tests
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download CRDs
        uses: actions/download-artifact@v4
        with:
          name: crds
          path: deploy/crds/

      - name: Create kind cluster
        uses: helm/kind-action@v1.8.0
        with:
          version: ${{ env.KIND_VERSION }}
          cluster_name: integration-shutdown
          node_image: kindest/node:${{ env.KUBERNETES_VERSION }}

      - name: Install CRDs
        run: kubectl apply -f deploy/crds/

      - name: Build controller
        run: make build

      - name: Run shutdown integration tests
        run: make test-integration-shutdown
        env:
          KUBECONFIG: ${{ env.KUBECONFIG }}

  integration-leader:
    name: Leader Election Tests
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download CRDs
        uses: actions/download-artifact@v4
        with:
          name: crds
          path: deploy/crds/

      - name: Create kind cluster
        uses: helm/kind-action@v1.8.0
        with:
          version: ${{ env.KIND_VERSION }}
          cluster_name: integration-leader
          node_image: kindest/node:${{ env.KUBERNETES_VERSION }}

      - name: Install CRDs
        run: kubectl apply -f deploy/crds/

      - name: Build controller
        run: make build

      - name: Run leader election tests
        run: make test-integration-leader
        env:
          KUBECONFIG: ${{ env.KUBECONFIG }}
          LEADER_ELECTION_DEBUG: true

  integration-scaling:
    name: Scaling Integration Tests
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download CRDs
        uses: actions/download-artifact@v4
        with:
          name: crds
          path: deploy/crds/

      - name: Create kind cluster
        uses: helm/kind-action@v1.8.0
        with:
          version: ${{ env.KIND_VERSION }}
          cluster_name: integration-scaling
          node_image: kindest/node:${{ env.KUBERNETES_VERSION }}

      - name: Install CRDs
        run: kubectl apply -f deploy/crds/

      - name: Build controller
        run: make build

      - name: Run scaling integration tests
        run: make test-integration-scale
        env:
          KUBECONFIG: ${{ env.KUBECONFIG }}
          SCALING_DEBUG: true

      - name: Upload scaling metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scaling-metrics
          path: /tmp/scaling-*.json
          retention-days: 7

  performance-tests:
    name: Performance Tests
    needs: setup
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download CRDs
        uses: actions/download-artifact@v4
        with:
          name: crds
          path: deploy/crds/

      - name: Create kind cluster
        uses: helm/kind-action@v1.8.0
        with:
          version: ${{ env.KIND_VERSION }}
          cluster_name: performance
          node_image: kindest/node:${{ env.KUBERNETES_VERSION }}
          config: |
            kind: Cluster
            apiVersion: kind.x-k8s.io/v1alpha4
            nodes:
            - role: control-plane
            - role: worker
            - role: worker

      - name: Install CRDs
        run: kubectl apply -f deploy/crds/

      - name: Build controller
        run: make build

      - name: Run performance tests
        run: make test-integration-performance
        env:
          KUBECONFIG: ${{ env.KUBECONFIG }}

      - name: Run benchmarks
        run: make test-performance-benchmarks

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: |
            benchmark-results.json
            performance-report.html
          retention-days: 30

      - name: Check for performance regression
        run: |
          # Compare with previous benchmark results
          # This would typically compare against stored baseline
          echo "Checking for performance regressions..."

  coverage-report:
    name: Coverage Report
    needs:
      - integration-basic
      - integration-runtime
      - integration-shutdown
      - integration-leader
      - integration-scaling
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download CRDs
        uses: actions/download-artifact@v4
        with:
          name: crds
          path: deploy/crds/

      - name: Create kind cluster
        uses: helm/kind-action@v1.8.0
        with:
          version: ${{ env.KIND_VERSION }}
          cluster_name: coverage
          node_image: kindest/node:${{ env.KUBERNETES_VERSION }}

      - name: Install CRDs
        run: kubectl apply -f deploy/crds/

      - name: Build controller
        run: make build

      - name: Run all tests with coverage
        run: make test-coverage-integration
        env:
          KUBECONFIG: ${{ env.KUBECONFIG }}

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage-integration.out
          flags: integration
          name: integration-coverage

      - name: Generate coverage badge
        run: |
          go tool cover -func=coverage-integration.out | grep total | awk '{print $3}' > coverage-percentage.txt

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage-integration.html
            coverage-integration.out
            coverage-percentage.txt
          retention-days: 30

  test-summary:
    name: Test Summary
    needs:
      - integration-basic
      - integration-runtime
      - integration-shutdown
      - integration-leader
      - integration-scaling
      - coverage-report
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "## Integration Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check each job status
          if [[ "${{ needs.integration-basic.result }}" == "success" ]]; then
            echo "✅ Basic Integration Tests: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Basic Integration Tests: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.integration-runtime.result }}" == "success" ]]; then
            echo "✅ Runtime Integration Tests: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Runtime Integration Tests: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.integration-shutdown.result }}" == "success" ]]; then
            echo "✅ Shutdown Integration Tests: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Shutdown Integration Tests: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.integration-leader.result }}" == "success" ]]; then
            echo "✅ Leader Election Tests: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Leader Election Tests: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.integration-scaling.result }}" == "success" ]]; then
            echo "✅ Scaling Integration Tests: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Scaling Integration Tests: Failed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `
            ## Integration Test Results

            | Test Suite | Status |
            |------------|--------|
            | Basic Integration | ${{ needs.integration-basic.result == 'success' && '✅' || '❌' }} |
            | Runtime Integration | ${{ needs.integration-runtime.result == 'success' && '✅' || '❌' }} |
            | Shutdown Integration | ${{ needs.integration-shutdown.result == 'success' && '✅' || '❌' }} |
            | Leader Election | ${{ needs.integration-leader.result == 'success' && '✅' || '❌' }} |
            | Scaling Integration | ${{ needs.integration-scaling.result == 'success' && '✅' || '❌' }} |
            | Coverage Report | ${{ needs.coverage-report.result == 'success' && '✅' || '❌' }} |
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });